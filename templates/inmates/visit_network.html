{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Réseau des Visites</h2>

    <div class="row mb-3">
        <div class="col-md-4">
            <select id="prisonSelector" class="form-select">
                <option value="">Toutes les prisons</option>
                {% for prison in prisons %}
                    <option value="{{ prison.id }}">{{ prison.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <select id="timeframeSelector" class="form-select">
                <option value="all">Toute la période</option>
                <option value="month">Dernier mois</option>
                <option value="quarter">Dernier trimestre</option>
                <option value="year">Dernière année</option>
            </select>
        </div>
    </div>

    <div id="visitNetwork" style="height: 700px; border: 1px solid #ddd; background-color: #f8f9fa;"></div>

    <div class="mt-3">
        <div class="d-flex justify-content-between">
            <button id="zoomIn" class="btn btn-outline-primary"><i class="fas fa-search-plus"></i></button>
            <button id="zoomOut" class="btn btn-outline-primary"><i class="fas fa-search-minus"></i></button>
            <button id="centerGraph" class="btn btn-outline-secondary"><i class="fas fa-compress-arrows-alt"></i></button>
        </div>
    </div>
</div>

<script type="text/javascript">
    const container = document.getElementById('visitNetwork');

    const options = {
        nodes: {
            shape: 'dot',
            scaling: {
                min: 10,
                max: 30,
                label: {
                    enabled: true,
                    min: 14,
                    max: 30,
                    maxVisible: 30,
                    drawThreshold: 5
                }
            },
            font: {
                size: 14,
                face: 'Arial'
            },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            width: 2,
            color: {
                color: '#2B7CE9',
                highlight: '#FFA500',
                hover: '#848484'
            },
            arrows: {
                to: {
                    enabled: true,
                    scaleFactor: 0.5
                }
            },
            smooth: {
                type: 'continuous'
            }
        },
        physics: {
            stabilization: {
                iterations: 100,
                fit: true
            },
            barnesHut: {
                gravitationalConstant: -2000,
                springConstant: 0.04,
                springLength: 200
            }
        },
        interaction: {
            tooltipDelay: 200,
            hover: true,
            zoomView: true,
            dragView: true,
            navigationButtons: true
        },
        groups: {
            inmates: {
                color: '#FF4444',
                shape: 'dot'
            },
            visitors: {
                color: '#4CAF50',
                shape: 'triangle'
            }
        }
    };

    let network = new vis.Network(container, { nodes: new vis.DataSet(), edges: new vis.DataSet() }, options);

    function loadNetworkData(prisonId = '', timeframe = 'all') {
        const url = `/inmates/visits/network/data/${prisonId}/?timeframe=${timeframe}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const nodes = new vis.DataSet(data.nodes);
                const edges = new vis.DataSet(data.edges);
                network.setData({nodes: nodes, edges: edges});
            })
            .catch(error => console.error('Erreur:', error));
    }

    // Événements pour les contrôles
    document.getElementById('prisonSelector').addEventListener('change', function(e) {
        loadNetworkData(e.target.value, document.getElementById('timeframeSelector').value);
    });

    document.getElementById('timeframeSelector').addEventListener('change', function(e) {
        loadNetworkData(document.getElementById('prisonSelector').value, e.target.value);
    });

    document.getElementById('zoomIn').addEventListener('click', function() {
        network.zoom(1.2);
    });

    document.getElementById('zoomOut').addEventListener('click', function() {
        network.zoom(0.8);
    });

    document.getElementById('centerGraph').addEventListener('click', function() {
        network.fit();
    });

    network.on('click', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            if (nodeId.startsWith('inmate_')) {
                const inmateId = nodeId.split('_')[1];
                window.location.href = `/inmates/${inmateId}/`;
            }
        }
    });

    // Chargement initial
    loadNetworkData();

    // Ajout d'animations et d'effets visuels
    network.on("stabilizationProgress", function(params) {
        // Vous pouvez ajouter une barre de progression ici si nécessaire
    });

    network.on("stabilizationIterationsDone", function() {
        network.setOptions( { physics: false } );
    });

    // Effet de survol
    network.on("hoverNode", function(params) {
        container.style.cursor = 'pointer';
    });

    network.on("blurNode", function(params) {
        container.style.cursor = 'default';
    });
</script>
{% endblock %}